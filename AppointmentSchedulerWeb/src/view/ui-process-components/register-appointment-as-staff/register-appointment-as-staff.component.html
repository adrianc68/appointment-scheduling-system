<section class="main-section">

  <section class="calendar data-section sp-bottom card">

    <app-calendar></app-calendar>
  </section>

  <section class="select-date data-section sp-bottom card">
    <h2>1. Selecciona una fecha</h2>
    <input class="input m-top-base" type="date" [ngModel]="selectedDate" (ngModelChange)="onDateChange($event)" />
  </section>



  <section class="select-client data-section sp-bottom card">
    <h2>1.1 Seleccionar cliente</h2>

    <div class="data-container m-top-base">
      <div class="data-actions">
        <div class="input container max-w-sm">
          <label class="input-icon" for="search"><mat-icon>search</mat-icon></label>
          <input id="search" class="input" type="text" placeholder="Buscar..." />
        </div>
      </div>
      <div class="data-header">
        <span class="fw-bold">Clientes registrados</span>
      </div>
      <div class="data-body table-type">

        <div class="data-body-no-data" *ngIf="clients?.length === 0">
          <mat-icon>search_off</mat-icon>
          <span>No se han encontrado registros</span>
        </div>
        <div class="client-card-container scroll-visible">
          <div class="client-data data-row-item" [class.selected-item-bg]="selectedClient?.uuid === data.uuid"
            (click)="selectedClient = data" *ngFor="let data of clients">
            <mat-icon class="profile-icon">person</mat-icon>
            <div class="client-info">
              <span class="fw-bold">{{data.name}}</span>
              <span class="fs-sm t-secondary">{{data.username}}</span>
              <!--<span class="fs-sm t-secondary">{{data.phoneNumber}}</span>-->
              <!--<span class="fs-sm t-secondary">{{data.status!}}</span>-->
            </div>
          </div>
        </div>
      </div>
      <div class="data-selected">
        <div class="data-selected m-top-md" *ngIf="selectedClient">
          <h3 class="m-bottom-md">Asistente seleccionado: </h3>
          <div class="assistant-summary">
            <div>
              <span class="fs-base t-muted m-bottom-base"> Nombre:</span>
              <span class="fs-base t-emphasis m-left-base">{{ selectedClient.name }}</span>
            </div>
            <div>
              <span class="fs-base t-muted m-bottom-base"> Nombre de usuario:</span>
              <span class="fs-base t-emphasis m-left-base"> {{ selectedClient.username}}</span>
            </div>
            <div>
              <span class="fs-base t-muted m-bottom-base"> Correo:</span>
              <span class="fs-base t-emphasis m-left-base"> {{ selectedClient.email}}</span>
            </div>
            <div>
              <span class="fs-base t-muted m-bottom-base"> Telefono:</span>
              <span class="fs-base t-emphasis m-left-base"> {{ selectedClient.phoneNumber}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="select-service data-section sp-bottom card">
    <h2>2. Selecciona los servicios</h2>

    <div class="data-container">
      <div class="data-actions">

      </div>
      <div class="data-header">
        <span>Servicios disponibles</span>
      </div>
      <div class="data-body table-type">
        <div class="data-body-no-data" *ngIf="servicesAvailable?.length === 0">
          <mat-icon>search_off</mat-icon>
          <span>No se han encontrado registros</span>
        </div>
        <div class="service-card-container scroll-visible">
          <div class="service-data data-row-item" *ngFor="let serviceOffer of servicesAvailable">
            <div class="icon">
              <mat-icon>support_agent</mat-icon>
              <span class="fs-base m-top-base">{{ serviceOffer.assistant?.name }}</span>
            </div>
            <div class="service-info">
              <span class="fs-base t-emphasis fw-bold">{{ serviceOffer.name}}</span>
              <div class="m-top-base">
                <span class="fs-sm t-muted">$ {{ serviceOffer.price}}</span>
                <span class="fs-sm t-muted m-left-base">-</span>
                <span class="fs-sm t-muted m-left-base">{{ serviceOffer.minutes}} min</span>
              </div>
            </div>
            <button class="button bordered m-y-center w-auto p-all-sm" (click)="selectServiceOffer(serviceOffer)">
              <mat-icon class="brand">add</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>


  <section class="selected-service data-section sp-bottom card">
    <h2>3. Servicios seleccionados</h2>
    <div class="data-container">
      <div class="data-actions">
      </div>
      <div class="data-header">
        <span>Servicios disponibles</span>
      </div>
      <div class="data-body table-type">
        <div class="data-body-no-data" *ngIf="selectedServicesOffer?.length === 0">
          <mat-icon>search_off</mat-icon>
          <span>No se han encontrado registros</span>
        </div>
        <div class="service-data data-row-item" *ngFor="let serviceOffer of selectedServicesOffer; let i = index;">
          <div class="icon">
            <mat-icon>support_agent</mat-icon>
            <span class="fs-base m-top-base">{{ serviceOffer.assistant?.name }}</span>
          </div>
          <div class="service-info">
            <span class="fs-base t-emphasis fw-bold">{{ serviceOffer.name}}</span>
            <div class="m-top-base">
              <span class="fs-sm t-muted">$ {{ serviceOffer.price}}</span>
              <span class="fs-sm t-muted m-left-base">-</span>
              <span class="fs-sm t-muted m-left-base">{{ serviceOffer.minutes}} min</span>
            </div>
            <div class="m-top-base">
              <label class="w-auto" for="startTime{{i}}">Hora de inicio:</label>
              <input id="startTime{{i}}" name="startTime{{i}}" type="time" step="1"
                [(ngModel)]="startTimes[serviceOffer.uuid]" required />
            </div>


            <!--<div class="slot-data d-inline">-->
            <!--  <span class="fs-base t-muted"> Descripción:</span>-->
            <!--  <p class="fs-base t-emphasis"> {{ serviceOffer.description}}</p>-->
            <!--</div>-->
          </div>

          <button class="button bordered m-y-center w-auto p-all-sm" (click)="removeSelectedService(serviceOffer)">
            <mat-icon class="danger">delete</mat-icon>
          </button>

        </div>
      </div>
      <div class="slot-data-container">
        <div class="slot-data d-flex-col">
          <span class="fs-base t-muted m-top-md"> Duración de la cita:</span>
          <span class="fs-base t-emphasis"> {{ getTotalMinutes() }} minutos</span>
        </div>
        <div class="slot-data d-flex-col">
          <span class="fs-base t-muted  m-top-md"> Total:</span>
          <span class="fs-base t-emphasis"> {{ getTotalPrice() | currency }}</span>
        </div>
      </div>
    </div>

  </section>


  <section class="appointments-scheduled data-section sp-bottom card">
    <section class="data-container">
      <section class="data-actions">
        <div class="grid-input-search input container">
          <label class="input-icon" for="search">
            <mat-icon>search</mat-icon>
          </label>
          <input id="search" class="input" type="text" placeholder="Buscar..." />
        </div>
      </section>

      <div class="data-header">
        <span class="fw-bold">Citas agendadas</span>
      </div>
      <div class="data-body table-type">

        <div class="data-body-no-data" *ngIf="scheduledAppointments?.length === 0">
          <mat-icon>search_off</mat-icon>
          <span>No se han encontrado registros</span>
        </div>
        <div class="card-container data-row-item accordion-type"
          *ngFor="let appointment of scheduledAppointments; let i = index">
          <div class="card-header" [class.expanded]="openedSlots.has(i)" (click)="toggleSlot(i)">
            <div class="card-icon">
              <mat-icon>person</mat-icon>
            </div>
            <div class="card-title d-flex">
              <div class="d-flex-col">
                <span class="fs-base fw-bold t-emphasis m-bottom-base">
                  Cita con {{ appointment.client?.name}}
                </span>
                <span class="fs-sm t-muted">
                  {{ appointment.startDate | slotDateRange: (appointment.endDate)}}
                </span>
              </div>
              <span class="fs-xs fw-bold" [ngClass]="{
        't-success': appointment.status === 'CONFIRMED',
        't-brand': appointment.status === 'SCHEDULED',
        't-danger': appointment.status === 'CANCELED',
        't-inverted': appointment.status === 'RESCHEDULED',
        't-muted': appointment.status === 'FINISHED',}">
                {{ appointment.status }}
              </span>
            </div>

            <button [class.clicked]="openedSlots.has(i)">
              <mat-icon>
                keyboard_arrow_right
              </mat-icon>
            </button>

          </div>
          <div class="card-body accordion-body" [class.expanded]="openedSlots.has(i)">
            <div class="wrapper  p-all-md">
              <div class="data-mgt">
                <div class="slot-data-row unbordered">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Fecha de creación:
                    </span>
                    <span class="t-emphasis ">
                      {{ appointment.createdAt | readableDate }}
                    </span>
                  </div>
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Fecha:
                    </span>
                    <span class="t-emphasis ">
                      {{ (appointment.startDate | slotDateRange: (appointment.endDate)).split('|')[0]}}
                    </span>
                  </div>
                </div>
                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Hora de inicio:
                    </span>
                    <span class="t-emphasis ">
                      {{ appointment.startDate | readableTime }}
                    </span>
                  </div>
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Hora de fin:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.endDate | readableTime }}
                    </span>
                  </div>
                </div>
                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Estado:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.status }}
                    </span>
                  </div>
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Costo:
                    </span>
                    <span class="t-emphasis">
                      $ {{ appointment.totalCost}}
                    </span>
                  </div>
                </div>
                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Duración:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.startDate | durationDate:appointment.endDate }}
                    </span>
                  </div>
                </div>

                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Identificador:
                    </span>
                    <span class="t-emphasis fs-xs">
                      {{ appointment.uuid }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="data-mgt m-bottom-md m-top-md">
                <span class="t-muted">Cliente: </span>
                <div class="slot-data-row unbordered">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Nombre:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.client?.name }}
                    </span>
                  </div>
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Teléfono:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.client!.phoneNumber }}
                    </span>
                  </div>
                </div>
                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Usuario:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.client?.username }}
                    </span>
                  </div>
                </div>
                <div class="slot-data-row">
                  <div class="slot-data d-flex-col">
                    <span class="t-muted">
                      Correo:
                    </span>
                    <span class="t-emphasis">
                      {{ appointment.client!.email }}
                    </span>
                  </div>
                </div>
              </div>
              <span class="t-muted">Servicios: </span>
              <div class="slot-data-row type-card d-flex-col transparent p-all-sm m-top-base"
                *ngFor="let scheduleService of appointment.scheduledServices">
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Servicio:
                  </span>
                  <span class="t-emphasis m-left-base">
                    {{ scheduleService.service.name }}
                  </span>
                </div>
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Precio:
                  </span>
                  <span class="t-emphasis m-left-base">
                    $ {{ scheduleService.service.price }}
                  </span>
                </div>
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Fecha:
                  </span>
                  <span class="t-emphasis m-left-base">
                    {{ (scheduleService.service.startDate | slotDateRange: (scheduleService.service.endDate))}}
                  </span>
                </div>
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Duración:
                  </span>
                  <span class="t-emphasis m-left-base">
                    {{ scheduleService.service.startDate | durationDate:scheduleService.service.endDate}}
                  </span>
                </div>
              </div>

              <span class="t-muted m-top-md">Asistentes: </span>
              <div class="slot-data-row type-card d-flex-col transparent p-all-sm m-top-base"
                *ngFor="let scheduleService of appointment.scheduledServices">
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Asistente:
                  </span>
                  <span class="t-emphasis m-left-base">
                    {{ scheduleService.assistant.name }}
                  </span>
                </div>
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Teléfono:
                  </span>
                  <span class="t-emphasis m-left-base">
                    {{ scheduleService.assistant.phoneNumber }}
                  </span>
                </div>
                <div class="slot-data d-inline">
                  <span class="t-muted">
                    Fecha de servicio:
                  </span>
                  <span class="t-emphasis">
                    {{ (scheduleService.service.startDate | slotDateRange: (scheduleService.service.endDate))}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </section>




  <section class="summary data-section card">
    <h2>Resumen</h2>

    <div class="slot-data-row">
      <div class="slot-data d-flex-col">
        <span class="fs-base t-muted"> Fecha:</span>
        <span class="fs-base t-emphasis"> {{ selectedDate }}</span>
      </div>
    </div>

    <div class="slot-data-row">
      <div class="slot-data d-flex-col">
        <span class="fs-base t-muted  "> Hora inicio:</span>
        <span class="fs-base t-emphasis"> {{ getEarliestStartTime() | readableTime }}</span>
      </div>
      <div class="slot-data d-flex-col">
        <span class="fs-base t-muted "> Hora fin:</span>
        <span class="fs-base t-emphasis"> {{ getEstimatedEndTime() | readableTime }}</span>
      </div>
    </div>

    <div class="slot-data-row">
      <div class="slot-data d-flex-col">
        <span class="fs-base t-muted "> Duración de la cita:</span>
        <span class="fs-base t-emphasis"> {{ getTotalMinutes() }} minutos</span>
      </div>
      <div class="slot-data d-flex-col">
        <span class="fs-base t-muted "> Total:</span>
        <span class="fs-base t-emphasis"> {{ getTotalPrice() | currency }}</span>
      </div>
    </div>

    <div class="d-flex-col gap-md m-top-lg">
      <div class="d-flex gap-md">
        <button class="button primary w-auto" (click)="blockTimeRange()">Bloquear rango de tiempo</button>
        <button class="button primary w-auto" (click)="registerAppointmentAsStaff()">Agendar cita</button>
      </div>
      <span>
        {{ translate(systemMessage ?? translationCodes.TC_EMPTY) }}
      </span>
    </div>

  </section>

</section>
